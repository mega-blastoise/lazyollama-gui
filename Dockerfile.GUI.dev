FROM oven/bun:1.2.4-alpine AS base

RUN mkdir -p /app/workspace

# Set up workspace
WORKDIR /app/workspace

FROM base AS dependency_installation

# Copy package files for dependency installation
COPY ./package.json ./package.json
COPY ./bun.lock* ./bun.lock*
COPY ./turbo.json ./turbo.json

# Create directory structure
RUN mkdir -p /app/workspace/core/gui /app/workspace/packages

# Install dependencies
COPY ./packages ./packages
COPY ./core/gui ./core/gui

RUN bun install

FROM dependency_installation AS build_packages

RUN bun run build

RUN bun run check-types

FROM build_packages as gui_dev_server

# Expose ports
EXPOSE 4040
EXPOSE 6006

# Command will be overridden by docker-compose
CMD ["bun", "run", "gui-dev"]